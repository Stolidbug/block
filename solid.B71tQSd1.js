const o={context:void 0,registry:void 0};function b(t){o.context=t}function _(){return{...o.context,id:`${o.context.id}${o.context.count++}-`,count:0}}const q=(t,e)=>t===e,E={equals:q};let I=z;const p=1,k=2,M={owned:null,cleanups:null,context:null,owner:null};var l=null;let P=null,tt=null,c=null,f=null,a=null,L=0;function et(t,e){const s=c,n=l,r=t.length===0,u=e===void 0?n:e,i=r?M:{owned:null,cleanups:null,context:u?u.context:null,owner:u},v=r?t:()=>t(()=>d(()=>N(i)));l=i,c=null;try{return x(v,!0)}finally{c=s,l=n}}function R(t,e){e=e?Object.assign({},E,e):E;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),W(s,r));return[Q.bind(s),n]}function nt(t,e,s){const n=D(t,e,!1,p);m(n)}function st(t,e,s){I=at;const n=D(t,e,!1,p),r=F&&G(F);r&&(n.suspense=r),n.user=!0,a?a.push(n):m(n)}function C(t,e,s){s=s?Object.assign({},E,s):E;const n=D(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,m(n),Q.bind(n)}function dt(t){return x(t,!1)}function d(t){if(c===null)return t();const e=c;c=null;try{return t()}finally{c=e}}function wt(t,e,s){const n=Array.isArray(t);let r;return u=>{let i;if(n){i=Array(t.length);for(let h=0;h<t.length;h++)i[h]=t[h]()}else i=t();const v=d(()=>e(i,r,u));return r=i,v}}function xt(t){st(()=>d(t))}function rt(t){return l===null||(l.cleanups===null?l.cleanups=[t]:l.cleanups.push(t)),t}function vt(){return c}function ut(){return l}function lt(t){a.push.apply(a,t),t.length=0}function V(t,e){const s=Symbol("context");return{id:s,Provider:ht(s),defaultValue:t}}function G(t){return l&&l.context&&l.context[t.id]!==void 0?l.context[t.id]:t.defaultValue}function ot(t){const e=C(t),s=C(()=>T(e()));return s.toArray=()=>{const n=s();return Array.isArray(n)?n:n!=null?[n]:[]},s}let F;function it(){return F||(F=V())}function Q(){if(this.sources&&this.state)if(this.state===p)m(this);else{const t=f;f=null,x(()=>U(this),!1),f=t}if(c){const t=this.observers?this.observers.length:0;c.sources?(c.sources.push(this),c.sourceSlots.push(t)):(c.sources=[this],c.sourceSlots=[t]),this.observers?(this.observers.push(c),this.observerSlots.push(c.sources.length-1)):(this.observers=[c],this.observerSlots=[c.sources.length-1])}return this.value}function W(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&x(()=>{for(let r=0;r<t.observers.length;r+=1){const u=t.observers[r],i=P&&P.running;i&&P.disposed.has(u),(i?!u.tState:!u.state)&&(u.pure?f.push(u):a.push(u),u.observers&&B(u)),i||(u.state=p)}if(f.length>1e6)throw f=[],new Error},!1)),e}function m(t){if(!t.fn)return;N(t);const e=L;ct(t,t.value,e)}function ct(t,e,s){let n;const r=l,u=c;c=l=t;try{n=t.fn(e)}catch(i){return t.pure&&(t.state=p,t.owned&&t.owned.forEach(N),t.owned=null),t.updatedAt=s+1,J(i)}finally{c=u,l=r}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?W(t,n):t.value=n,t.updatedAt=s)}function D(t,e,s,n=p,r){const u={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:l,context:l?l.context:null,pure:s};return l===null||l!==M&&(l.owned?l.owned.push(u):l.owned=[u]),u}function $(t){if(t.state===0)return;if(t.state===k)return U(t);if(t.suspense&&d(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<L);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===p)m(t);else if(t.state===k){const n=f;f=null,x(()=>U(t,e[0]),!1),f=n}}function x(t,e){if(f)return t();let s=!1;e||(f=[]),a?s=!0:a=[],L++;try{const n=t();return ft(s),n}catch(n){s||(a=null),f=null,J(n)}}function ft(t){if(f&&(z(f),f=null),t)return;const e=a;a=null,e.length&&x(()=>I(e),!1)}function z(t){for(let e=0;e<t.length;e++)$(t[e])}function at(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:$(n)}if(o.context){if(o.count){o.effects||(o.effects=[]),o.effects.push(...t.slice(0,s));return}else o.effects&&(t=[...o.effects,...t],s+=o.effects.length,delete o.effects);b()}for(e=0;e<s;e++)$(t[e])}function U(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===p?n!==e&&(!n.updatedAt||n.updatedAt<L)&&$(n):r===k&&U(n,e)}}}function B(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=k,s.pure?f.push(s):a.push(s),s.observers&&B(s))}}function N(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const u=r.pop(),i=s.observerSlots.pop();n<r.length&&(u.sourceSlots[i]=n,r[n]=u,s.observerSlots[n]=i)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)N(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function pt(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function J(t,e=l){throw pt(t)}function T(t){if(typeof t=="function"&&!t.length)return T(t());if(Array.isArray(t)){const e=[];for(let s=0;s<t.length;s++){const n=T(t[s]);Array.isArray(n)?e.push.apply(e,n):e.push(n)}return e}return t}function ht(t,e){return function(n){let r;return nt(()=>r=d(()=>(l.context={...l.context,[t]:n.value},ot(()=>n.children))),void 0),r}}let K=!1;function yt(){K=!0}function gt(t,e){if(K&&o.context){const s=o.context;b(_());const n=d(()=>t(e||{}));return b(s),n}return d(()=>t(e||{}))}const bt=V();function St(t){let e=0,s,n,r,u,i;const[v,h]=R(!1),X=it(),y={increment:()=>{++e===1&&h(!0)},decrement:()=>{--e===0&&h(!1)},inFallback:v,effects:[],resolved:!1},Y=ut();if(o.context&&o.load){const S=o.context.id+o.context.count;let w=o.load(S);if(w&&(typeof w!="object"||w.status!=="success"?r=w:o.gather(S)),r&&r!=="$$f"){const[O,A]=R(void 0,{equals:!1});u=O,r.then(()=>{if(o.done)return A();o.gather(S),b(n),A(),b()},j=>{i=j,A()})}}const H=G(bt);H&&(s=H.register(y.inFallback));let g;return rt(()=>g&&g()),gt(X.Provider,{value:y,get children(){return C(()=>{if(i)throw i;if(n=o.context,u)return u(),u=void 0;n&&r==="$$f"&&b();const S=C(()=>t.children);return C(w=>{const O=y.inFallback(),{showContent:A=!0,showFallback:j=!0}=s?s():{};if((!O||r&&r!=="$$f")&&A)return y.resolved=!0,g&&g(),g=n=r=void 0,lt(y.effects),S();if(j)return g?w:et(Z=>(g=Z,n&&(b({id:n.id+"f",count:0}),n=void 0),t.fallback),Y)})})}})}export{St as S,nt as a,gt as b,et as c,R as d,yt as e,xt as f,dt as g,vt as h,ut as i,C as j,st as k,wt as l,rt as o,o as s,d as u};
